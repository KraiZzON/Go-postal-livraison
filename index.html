<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Go Postal - Suivi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    
    <style>
        body { 
            font-family: system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .bg-animated {
            background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab);
            background-size: 400% 400%;
            animation: gradient 15s ease infinite;
        }
        
        @keyframes gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        .fade-in { animation: fadeIn 0.5s ease-out; }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .pulse-icon { animation: pulse 2s infinite; }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
    </style>
</head>
<body class="bg-animated">
    <div id="app"></div>

    <script>
        // config firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDxvLw4S3npQIUYS72uk6xtcJ-bImGPiQI",
            authDomain: "go-postal-96c85.firebaseapp.com",
            databaseURL: "https://go-postal-96c85-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "go-postal-96c85",
            storageBucket: "go-postal-96c85.firebasestorage.app",
            messagingSenderId: "632274389956",
            appId: "1:632274389956:web:5330031c5b36b7c97df291"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let trackNum = '';
        let order = null;
        let isLoading = false;
        let listener = null;

        const steps = [
            { id: 'received', name: 'Commande re√ßue', emoji: 'üìã', color: '#6366f1' },
            { id: 'preparing', name: 'En pr√©paration', emoji: 'üì¶', color: '#3b82f6' },
            { id: 'delivering', name: 'En livraison', emoji: 'üöö', color: '#f59e0b' },
            { id: 'delivered', name: 'Livr√©e', emoji: '‚úÖ', color: '#10b981' }
        ];

        function showMsg(msg, type) {
            const colors = {
                ok: 'bg-green-500',
                err: 'bg-red-500',
                warn: 'bg-orange-500'
            };
            
            const div = document.createElement('div');
            div.className = `fixed top-4 right-4 ${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg z-50 fade-in`;
            div.textContent = msg;
            document.body.appendChild(div);
            
            setTimeout(() => div.remove(), 3000);
        }

        async function search() {
            const id = trackNum.trim();
            
            if (!id) {
                showMsg('‚ö†Ô∏è Entre un num√©ro', 'warn');
                return;
            }

            isLoading = true;
            render();

            try {
                const snap = await db.ref('orders/' + id).once('value');
                const data = snap.val();
                
                if (data) {
                    order = data;
                    showMsg('‚úÖ Trouv√©e !', 'ok');
                    
                    // ecoute les changements
                    watchOrder(id);
                } else {
                    order = null;
                    showMsg('‚ùå Pas trouv√©e', 'err');
                }
            } catch (e) {
                showMsg('‚ùå Erreur', 'err');
                console.error(e);
            }
            
            isLoading = false;
            render();
        }

        function watchOrder(id) {
            if (listener) {
                db.ref('orders/' + id).off('value', listener);
            }

            listener = db.ref('orders/' + id).on('value', (snap) => {
                const newData = snap.val();
                
                if (newData && order) {
                    if (newData.status !== order.status) {
                        showMsg('üîÑ Mis √† jour !', 'ok');
                        order = newData;
                        render();
                        
                        // scroll vers status actuel
                        setTimeout(() => {
                            const active = document.querySelector('.pulse-icon');
                            if (active) active.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }, 100);
                    } else {
                        order = newData;
                        render();
                    }
                }
            });
        }

        function getIdx(status) {
            return steps.findIndex(s => s.id === status);
        }

        function renderTracking() {
            if (!order) return '';
            
            const idx = getIdx(order.status);
            
            let html = '';
            steps.forEach((step, i) => {
                const active = i <= idx;
                const current = i === idx;
                
                html += `
                    <div class="relative fade-in" style="animation-delay: ${i * 0.1}s">
                        ${i < steps.length - 1 ? `
                            <div class="absolute left-8 top-20 w-0.5 h-20" 
                                 style="background: ${i < idx ? step.color : '#e5e7eb'}"></div>
                        ` : ''}
                        <div class="flex items-start gap-6">
                            <div class="${current ? 'pulse-icon' : ''} w-16 h-16 rounded-full flex items-center justify-center text-3xl shadow-lg"
                                 style="background: ${active ? step.color : '#e5e7eb'}; color: white;">
                                ${step.emoji}
                            </div>
                            <div class="flex-1 pt-3">
                                <h3 class="font-bold text-xl" style="color: ${active ? '#1f2937' : '#9ca3af'}">
                                    ${step.name}
                                </h3>
                                ${current ? `
                                    <div class="flex items-center gap-2 mt-2">
                                        <div class="w-2 h-2 rounded-full animate-pulse" style="background: ${step.color}"></div>
                                        <p class="text-sm font-semibold" style="color: ${step.color}">En cours</p>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            });

            return `
                <div class="mt-8 fade-in">
                    <div class="text-center p-8 rounded-2xl mb-8" 
                         style="background: ${steps[idx].color}20; border: 2px solid ${steps[idx].color}30;">
                        <div class="text-5xl mb-4">üì¶</div>
                        <h2 class="text-3xl font-bold text-gray-800 mb-3">Commande ${order.id}</h2>
                        <p class="text-xl text-gray-700 font-medium">${order.customerName}</p>
                        <p class="text-sm text-gray-500 mt-2">${order.customerEmail}</p>
                    </div>
                    
                    <div class="space-y-8 mb-8">${html}</div>
                    
                    <div class="text-center p-4 rounded-xl" style="backdrop-filter: blur(10px); background: rgba(255,255,255,0.1);">
                        <p class="text-sm text-white">
                            üìÖ Mis √† jour : ${new Date(order.updatedAt).toLocaleString('fr-FR')}
                        </p>
                    </div>
                </div>
            `;
        }

        function render() {
            document.getElementById('app').innerHTML = `
                <div class="min-h-screen p-4 py-12">
                    <div class="max-w-4xl mx-auto">
                        <!-- logo -->
                        <div class="text-center mb-8 fade-in">
                            <div style="background: white; padding: 20px; border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); display: inline-block;">
                                <svg viewBox="0 0 400 150" style="width: 150px; height: auto;">
                                    <path d="M 50 75 A 40 40 0 1 1 50 74.9" fill="none" stroke="#E63946" stroke-width="20" stroke-linecap="round"/>
                                    <text x="70" y="95" font-size="80" font-weight="bold" fill="#E63946" font-family="Arial">G</text>
                                    <path d="M 150 40 A 35 35 0 1 1 150 39.9" fill="none" stroke="#457B9D" stroke-width="18" stroke-linecap="round"/>
                                    <text x="40" y="140" font-size="40" font-weight="bold" fill="#2B2D42" font-family="Arial">Postal</text>
                                </svg>
                            </div>
                        </div>

                        <!-- main card -->
                        <div class="rounded-3xl shadow-2xl p-8 md:p-12 fade-in" 
                             style="backdrop-filter: blur(10px); background: rgba(255,255,255,0.95);">
                            <div class="text-center mb-10">
                                <h1 class="text-4xl md:text-5xl font-bold text-gray-800 mb-3">
                                    Suivez votre colis
                                </h1>
                                <p class="text-lg text-gray-600">
                                    Entrez votre num√©ro de suivi
                                </p>
                            </div>

                            <!-- search -->
                            <div class="mb-10">
                                <label class="block text-sm font-bold text-gray-700 mb-3 uppercase">
                                    Num√©ro de commande
                                </label>
                                <div class="flex gap-3">
                                    <input 
                                        type="text" 
                                        id="inp" 
                                        placeholder="CMD1734567890123"
                                        class="flex-1 px-6 py-4 border-2 border-gray-300 rounded-xl text-lg"
                                        value="${trackNum}"
                                        ${isLoading ? 'disabled' : ''}>
                                    <button 
                                        id="btn"
                                        style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);"
                                        class="px-8 py-4 text-white rounded-xl font-bold text-lg shadow-lg ${isLoading ? 'opacity-50' : ''}"
                                        ${isLoading ? 'disabled' : ''}>
                                        ${isLoading ? '‚è≥ ...' : 'üîç Suivre'}
                                    </button>
                                </div>
                                <p class="text-xs text-gray-500 mt-3">
                                    üí° Le num√©ro vous a √©t√© envoy√© par email
                                    ${order ? '<span class="ml-4 text-green-600 font-semibold">üîÑ Live</span>' : ''}
                                </p>
                            </div>

                            <!-- result -->
                            ${order ? renderTracking() : `
                                <div class="text-center py-16 fade-in">
                                    <div class="w-32 h-32 mx-auto mb-6 rounded-full flex items-center justify-center" 
                                         style="backdrop-filter: blur(10px); background: rgba(255,255,255,0.1);">
                                        <span class="text-6xl">üì¶</span>
                                    </div>
                                    <p class="text-xl text-gray-600">
                                        Entrez votre num√©ro pour commencer
                                    </p>
                                </div>
                            `}
                        </div>
                        
                        <!-- footer -->
                        <div class="text-center mt-8 fade-in">
                            <div class="rounded-2xl p-6" style="backdrop-filter: blur(10px); background: rgba(255,255,255,0.1);">
                                <p class="text-white font-medium mb-2">Besoin d'aide ?</p>
                                <p class="text-sm text-white opacity-80">Contactez notre service</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // events
            const inp = document.getElementById('inp');
            const btn = document.getElementById('btn');

            if (inp && btn) {
                inp.oninput = (e) => trackNum = e.target.value;
                
                inp.onkeypress = (e) => {
                    if (e.key === 'Enter' && !isLoading) search();
                };

                btn.onclick = () => {
                    if (!isLoading) search();
                };

                if (!order) inp.focus();
            }
        }

        // go
        render();
    </script>
</body>
</html>
